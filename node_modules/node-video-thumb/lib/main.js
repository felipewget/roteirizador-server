const path = require('path')
const childProcess = require('child_process')
const util = require('util')

const exec = util.promisify(childProcess.exec).bind(childProcess)

/**
 * input video's path, seconds from start, thumb's path, thumb's width, thumb's height
 * 
 * @param {String} source
 * @param {String} target
 * @param {Number} width
 * @param {Number} height
 * @param {Number} seconds
 * @return {Promise<void>}
 * @public
 */

exports = module.exports = async function generateThumb ({ source, target, width, height, seconds }) {
  if (!path.isAbsolute(source)) {
    throw new Error('source should be absolute path')
  }
  if (!path.isAbsolute(target)) {
    throw new Error('target should be absolute path')
  }
  if (typeof width !== 'number') {
    throw new TypeError('width should be a number')
  }
  if (typeof height !== 'number') {
    throw new TypeError('height should be a number')
  }
  if (typeof seconds !== 'number') {
    throw new TypeError('seconds should be a number')
  }

  width = Math.abs(parseInt(width))
  height = Math.abs(parseInt(height))
  seconds = Math.abs(parseInt(seconds))

  const timestr = `${parseInt(seconds / 3600)}:${parseInt(seconds / 60) % 60}:${seconds % 60}`

  await exec(`ffmpeg -i "${source}" -ss "${timestr}" -s ${width}x${height} -vframes 1 "${target}`)
}
